<head>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>

<div id="app">
  {{ page.pageTitle }} ({{ page.id }})
  <br>
  <block
    v-for="block in page.children"
    v-bind:block="block"
    v-bind:level="0"
    v-bind:key="block.id">
  </block>
</div>

<script>
var pageTitle = "";
var pageData = {pageTitle: pageTitle, children: []};
var httpRequest;

function alertContents() {
    if (httpRequest.readyState === XMLHttpRequest.DONE) {
      if (httpRequest.status === 200) {
        app.page = JSON.parse(httpRequest.responseText);
      } else {
        alert('There was a problem with the request.');
      }
    }
  }

Vue.component('block', {
  props: ['block', 'level'],
  data: function () {
    return {
      styleObject: {
        marginLeft: (this.level * 10) + "px"
      }
    }
  },
  methods: {
    gainFocus: function(event) {
      this.startingText = event.target.textContent;
      var blockId = this.block.id;
      var level = this.level;
      event.target.onkeydown = function(e) {
        if ( e.keyCode == 13 ){        
          e.preventDefault();
          if (level == 0) {
            createBlockInPage(app.page.id);
          } else { createBlockInBlock(blockId); }
        }
      }
    },
    loseFocus: function(event) {
      event.target.onkeydown = function(e) {};
      //only send the update request if the text has changed
      if (this.startingText == event.target.textContent) { return; }
      var updateBlockRequest;
      updateBlockRequest = new XMLHttpRequest();
      updateBlockRequest.onreadystatechange = function() {
        if (updateBlockRequest.readyState === XMLHttpRequest.DONE) {
              if (updateBlockRequest.status === 200) {
                loadPage();
              }
            }
        };
      var apiRoute = "/api/update/" + this.block.id + "?newtext=" + event.target.textContent;
      updateBlockRequest.open('GET', apiRoute, true);
      updateBlockRequest.send();
    }
  },
  template: '<span v-bind:style="this.styleObject">* <span contenteditable="true" v-on:focusin="gainFocus" v-on:focusout="loseFocus" v-html="block.text"></span><br /><block v-for="child in block.children" v-bind:block="child" v-bind:level="level + 1" v-bind:key="child.id"> </block></span>'})

var app = new Vue({
  el: '#app',
  data: {page: pageData, currentRoute: window.location.pathname}
})

function loadPage() {
httpRequest = new XMLHttpRequest();
httpRequest.onreadystatechange = alertContents;
var apiRoute = "/api/daily-notes";
if (app.currentRoute != "/") { apiRoute = app.currentRoute.replace("app", "api") }
httpRequest.open('GET', apiRoute);
httpRequest.send();
}

function createBlockInBlock(blockId) {
      var newBlockRequest;
      newBlockRequest = new XMLHttpRequest();
      newBlockRequest.onreadystatechange = function() {
        if (newBlockRequest.readyState === XMLHttpRequest.DONE) {
              if (newBlockRequest.status === 200) {
                loadPage();
              }
            }
        };
      var apiRoute = "/api/new/block/" + blockId;
      newBlockRequest.open('GET', apiRoute, true);
      newBlockRequest.send();
}

function createBlockInPage(pageId) {
      var newBlockRequest;
      newBlockRequest = new XMLHttpRequest();
      newBlockRequest.onreadystatechange = function() {
        if (newBlockRequest.readyState === XMLHttpRequest.DONE) {
              if (newBlockRequest.status === 200) {
                loadPage();
              }
            }
        };
      var apiRoute = "/api/new/block/page/" + pageId;
      newBlockRequest.open('GET', apiRoute, true);
      newBlockRequest.send();
}

loadPage();
</script>
